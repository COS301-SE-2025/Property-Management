name: Frontend CI

on:
  workflow_call:
  push:
      branches: [frontend]
  pull_request:
      branches: [frontend]

jobs:
    lint:
        runs-on: ubuntu-22.04
        steps:
            - uses: actions/checkout@v3

            - name: Cache node_modules
              uses: actions/cache@v3
              with:
                path: Frontend/node_modules
                key: npm-${{ hashFiles('Frontend/package-lock.json') }}
                restore-keys: |
                  npm-

            - name: Install dependencies
              run: npm ci
              working-directory: Frontend/

            - name: Lint code
              run: ng lint property-manager
              working-directory: Frontend/Property-Manager
        
    audit:
      runs-on: ubuntu-22.04
      needs: lint
      steps:
        - uses: actions/checkout@v3

        - name: Cache node_modules
          uses: actions/cache@v3
          with:
              path: Frontend/node_modules
              key: npm-${{ hashFiles('Frontend/package-lock.json') }}
              restore-keys: |
                npm-
            
        - name: Install dependencies
          run: npm ci
          working-directory: Frontend/

        - name: Audit packages
          run: npm audit || [ $? -eq 1 ] || exit $?
          working-directory: Frontend/
          
        - name: Fail on critical vulnerabilites 
          run: npm audit --audit-level=critical
          working-directory: Frontend/

    build-library:
      runs-on: ubuntu-22.04
      needs: audit
      steps:
        - uses: actions/checkout@v3
        
        - name: Cache node_modules
          uses: actions/cache@v3
          with:
            path: Frontend/node_modules
            key: npm-${{ hashFiles('Frontend/package-lock.json') }}
            restore-keys: |
              npm-

        - name: Install dependencies
          run: npm ci
          working-directory: Frontend

        - name: Build shared library
          run: npm run build shared
          working-directory: Frontend

    build:
        runs-on: ubuntu-22.04
        needs: [audit, build-library]
        steps:
            - uses: actions/checkout@v3

            - name: Cache node_modules
              uses: actions/cache@v3
              with:
                path: Frontend/node_modules
                key: npm-${{ hashFiles('Frontend/package-lock.json') }}
                restore-keys: |
                  npm-

            - name: Install dependencies
              run: npm ci
              working-directory: Frontend

            - name: Build Angular website
              run: npm run build property-manager
              working-directory: Frontend
      
    test:
      runs-on: ubuntu-22.04
      needs: build
      steps:
          - uses: actions/checkout@v3

          - name: Cache node_modules
            uses: actions/cache@v3
            with:
                path: Frontend/node_modules
                key: npm-${{ hashFiles('Frontend/package-lock.json') }}
                restore-keys: |
                  npm-

          - name: Install dependencies
            run: npm ci
            working-directory: Frontend

          - name: Run unit and integration tests
            run: npm run test property-manager -- --watch=false --browsers=ChromeHeadlessCI
            working-directory: Frontend